import yfinance as yf
import pandas_ta as ta
import os
from telegram import Bot
from telegram.constants import ParseMode
import asyncio

TOKEN = os.getenv('TELEGRAM_TOKEN')
CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

TICKERS = [
    "ASII.JK", "BBCA.JK", "BBRI.JK", "BMRI.JK", "TLKM.JK",
    "GOTO.JK", "ANTM.JK", "ADRO.JK", "UNTR.JK", "PGAS.JK",
    "CPIN.JK", "HRUM.JK", "MDKA.JK", "INCO.JK", "KLBF.JK"
]

async def screener():
    bot = Bot(token=TOKEN)
    hasil = []

    for t in TICKERS:
        try:
            df = yf.download(t, period="1y", interval="1d", progress=False)
            if df.empty or len(df) < 200:
                continue

            # Likuiditas minimal 10 miliar
            avg_value = (df["Close"] * df["Volume"]).tail(20).mean()
            if avg_value < 10_000_000_000:
                continue

            # Indikator
            df["RSI"] = ta.rsi(df["Close"], length=14)
            df["ATR"] = ta.atr(df["High"], df["Low"], df["Close"], length=14)

            last = df.iloc[-1]
            prev = df.iloc[-2]

            # Sinyal BSJP
            if last["Close"] > prev["Close"] and last["Volume"] > df["Volume"].tail(5).mean():
                tp = last["Close"] + (last["ATR"] * 1.5)
                sl = last["Close"] - (last["ATR"] * 1.5)

                hasil.append(
                    f"ðŸŽ¯ *{t}*\n"
                    f"Entry: {last['Close']:.0f}\n"
                    f"TP: {tp:.0f} | SL: {sl:.0f}\n"
                    f"RSI: {last['RSI']:.1f}"
                )

        except Exception:
            continue

    pesan = "ðŸš€ *DAFTAR BELANJA SORE (BSJP)*\n\n"
    pesan += "\n\n".join(hasil[:10]) if hasil else "Belum ada sinyal kuat sore ini."

    await bot.send_message(chat_id=CHAT_ID, text=pesan, parse_mode=ParseMode.MARKDOWN)

if __name__ == "__main__":
    asyncio.run(screener())
